fbb.map = function(){
    var self = this;
    self.map = {};
    fbb.lat = fbb.defaultLat;
    fbb.lng = fbb.defaultLng;
    var mapEl;
    var $_addressInput;
    var icon_path = "<%= image_path 'icon/ball_pointer.png' %>";
    self.mapOptions = {};
    self.mapObj = {};


    var initialize = function(){
        checkForMap();
        checkForSearchResults();
        showCourtDOM();
        courtSearchGeoComplete( $("#courtAddress"));
    };

    var checkForSearchResults = function(){
        if ($("#find_hoops_canvas").length){
            populateDistances();
        }
    };

    var populateDistances = function(){
        $(".result_distance").each(function(i, _this){
            var lat = parseFloat( $(this).children('.courtLat').val() );
            var lng = parseFloat( $(this).children('.courtLng').val() );
            getDistance(gon.lat, gon.lng, lat, lng, $(this));
        });

        console.log("debugging lat lng for gon");
        debugLatLng(gon.lat, gon.lng);


    };

    var debugLatLng = function(_lat, _lng){ //DEBUG
        var _latLng = new google.maps.LatLng(parseFloat(_lat), parseFloat(_lng));
        var geocoder = new google.maps.Geocoder();
        geocoder.geocode({'latLng': _latLng}, function(results, status){
            console.log("origin results");
            console.log(results[0].formatted_address);
        });
    }


    var checkForMap = function(){
        var mapEl = $(".mapEl");
        if(mapEl.length){
            mapEl = $(".mapEl")[0];
            var whichMap = $(".mapEl").attr("id");
            var mapOptions;
            console.log("the map is " + whichMap);
            setupOptions();
            fbb.map = new google.maps.Map(mapEl, self.courtMapOptions);
            switch(whichMap){
                case "court_map":
                    getDistance(fbb.defaultLat, fbb.defaultLng, self.mapObj.lat, self.mapObj.lng, $("#milesAway"));
                    break;
                case "add_court_map":
                case "edit_court_map":
                    setupCourtCursor();
                    addCourtDOM();
                break;
            }
        }
    };

    var getLatLng = function(){
        self.mapObj = self.mapObj || {};
        if(typeof gon !== "undefined"){
            if (gon.lat && gon.lng){
                self.mapObj.lat = parseFloat( gon.lat );
                self.mapObj.lng = parseFloat( gon.lng );
            }
        } else {
            console.log("gon is not loaded");
        }
    };

    var simpleMap = function(){
        //to test that the map is working
        self.map = new google.maps.Map(mapEl, self.mapOptions);
    };

    var setupOptions = function(){
        getLatLng();
        self.courtMapOptions = {
            center: new google.maps.LatLng(self.mapObj.lat, self.mapObj.lng),
            zoom: 15,
            scrollwheel: false,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
        };
    };

    var prepareCourtMap = function(mapEl){
        self.map = new google.maps.Map(mapEl, self.courtMapOptions);
        setupCourtCursor();
        addCourtDOM();
        //TODO - get members lat and lng, then result to thing
        getDistance(fbb.defaultLat, fbb.defaultLng, self.mapObj.lat, self.mapObj.lng, $("#milesAway"));
    };

    var getDistance = function(lat1, lng1, lat2, lng2, result_el){

        var service = new google.maps.DistanceMatrixService();
        var origin = new google.maps.LatLng(parseFloat(lat1), parseFloat(lng1));
        var destination = new google.maps.LatLng(parseFloat(lat2), parseFloat(lng2));

        var foundDistanceHandler = function(response, status){
            if( status != google.maps.DistanceMatrixStatus.OK){
                console.log("Error was: " + status);
            } else {
                var data = response.rows[0].elements[0];
                if(data.status === "OK"){
                    populateDistance( data.distance.value, result_el );
                }
            }
        };

        var populateDistance = function( distance, result_el ){
            var milesAway = parseFloat( parseFloat( toMiles( distance ) ).toFixed(1));
            var milesAwayString = "mile".pluralize(milesAway);
            result_el.text(milesAway + " " + milesAwayString + " away");
        };


        service.getDistanceMatrix(
            {
                origins : [origin],
                destinations : [destination],
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC,
                avoidHighways: false,
                avoidTolls: false
            }, foundDistanceHandler
        );

    };


    var toMiles = function(meters){
        return meters *= 0.000621371192;
    }

    var clearMarkers = function(){
        if(fbb.marker){
            fbb.marker.setMap(null);
            fbb.marker = null;
        }
    }

    var setupCourtCursor = function(){
        fbb.marker = new google.maps.Marker({
            icon: icon_path,
            position: self.mapOptions.center,
            map: self.map
        });
    };

    var setupDraggableMapCursor = function(_point){
        fbb.marker = new google.maps.Marker({
            icon: icon_path,
            draggable: true,
            position: _point,
            map: self.map
        });
        return fbb.marker;
    }

    var courtSearchGeoComplete = function(_input){
        $_addressInput = $("#address_search");
        if( $_addressInput.length ){
            $_addressInput.geocomplete({
                map: ".mapEl",
                location: new google.maps.LatLng(self.mapObj.lat, self.mapObj.lng),
                mapOptions: {
                    zoom: 15,
                    scrollwheel: false,
                    mapTypeId: "roadmap"
                },
                markerOptions: {
                    draggable: true,
                    icon: icon_path
                }
            })
            .bind("geocode:result", courtSearchSuccessHandler)
            .bind("geocode:dragged", courtSearchDraggedHandler)
            .bind("geocode:error", function(event, result){
                console.log(event);
                console.log(result);
            });
        }
    };


    var autoComplete = function(){
        console.log("setting up autoComplete");
        var service = new google.maps.places.AutocompleteService();
        if( $("#address_search").length ){
            $("#address_search").typeahead({
                source: function(query, process){
                    console.log("source");
                    service.getPlacePredictions({
                        input: query
                    }, function(predictions, status) {
                        if (status == google.maps.places.PlacesServiceStatus.OK) {
                            process($.map(predictions, function(prediction) {
                                $("#addressNotFound").fadeOut();
                                return prediction.description;
                            }));
                        } else {
                            $("#addressNotFound").fadeIn();
                        }
                    });
                },
                updater: function(_address){
                    console.log("looking up addressss");
                    return lookUpAutoCompleteAddress(_address);
                }
            });
        }
    };


    var lookUpAutoCompleteAddress = function(_address){
        self.geocoder = self.geocoder || new google.maps.Geocoder();
        self.address = _address;
        self.geocoder.geocode({ address: _address}, displayAutoCompleteResults);
    };

    var displayAutoCompleteResults = function(results, status){
        if( status != google.maps.GeocoderStatus.OK ){
            return autoCompleteFailureHandler(results, status);
        } else {
            return autoCompleteSuccessHandler(results, status);
        }
    };

    var courtSearchDraggedHandler = function(event, result){
        var lat = parseFloat(result.k);
        var lng = parseFloat(result.B);
        var latlng = new google.maps.LatLng(lat, lng);
        self.geocoder = self.geocoder || new google.maps.Geocoder();
        self.geocoder.geocode({'latLng':latlng}, function(results, status){
            if(status == google.maps.GeocoderStatus.OK){
                if (results[0]){
                    console.log(results[0].formatted_address);
                    self.address = results[0].formatted_address;
                    populateDom(self.address, lat, lng);
                    $(".edit_court").submit();
                }
            }
        });
    };


    var courtSearchSuccessHandler = function(event, result){
        //TODO - make a case by case function
       var _address = result.formatted_address;
       self.address = _address;
       var lat = result.geometry.location.k;
       var lng = result.geometry.location.B;
       populateDom(_address, lat, lng);
       $(".edit_court").submit();
    };

    var populateDom = function(_address, lat, lng){
        populateLatLng(lat, lng);
        populateLocation( _address );
        $_addressInput.val(_address);
        $(".address_search_container").hide();
        $(".map_results_container").show();
        $("#addressNotFound").hide();
        $("#address_search_result").html(self.address + "<br><i>Drag basketball for better court placement</i>");
    }

    var populateLatLng = function(lat, lng){
        $("#court_lat").val(lat);
        $("#court_lng").val(lng);
    }

    var populateLocation = function(location){
        $("#court_location").val(location);
    }


    var autoCompleteFailureHandler = function(results, status){
        $("#addressNotFound").fadeIn();
        var addressSearchEl = $("#address_search");
        addressSearchEl.val("");
        addressSearchEl.focus();
    };

    var addCourtDOM = function(){
        $("#searchAgain").click(function(e){
            e.preventDefault();
            clearMarkers();
            $(".address_search_container").show();
            $(".map_results_container").hide();
        });

        $("#submitMap").click(function(e){
            e.preventDefault();
            autoCompleteFailureHandler();
        });
    }

    var showCourtDOM = function(){
        var addressEl = $("#showCourtAddress");

    };

    initialize();
}


